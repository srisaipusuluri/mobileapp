<script>
  let html5QrCode;
  const eventList = document.getElementById('eventList');
  const log = document.getElementById('log');
  let scans = JSON.parse(localStorage.getItem('scans') || '{}');
  let isAdmin = false;

  window.addEventListener('load', () => {
    // Load saved events
    for (const name in scans) {
      const option = new Option(name, name);
      eventList.add(option);
    }
  });

  function loginAdmin() {
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('pinSection').classList.remove('hidden');
  }

  function verifyPin() {
    const pin = document.getElementById('adminPin').value;
    if (pin === "1234") {
      isAdmin = true;
      document.getElementById('pinSection').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('exportBtn').classList.remove('hidden');
    } else {
      alert("Incorrect PIN");
    }
  }

  function saveData() {
    localStorage.setItem('scans', JSON.stringify(scans));
  }

  function addEvent() {
    const name = document.getElementById('newEvent').value.trim();
    if (!name || scans[name]) return;
    const option = new Option(name, name);
    eventList.add(option);
    scans[name] = [];
    eventList.value = name;
    document.getElementById('newEvent').value = "";
    saveData();
  }

  function startScanner() {
    const eventName = eventList.value;
    if (!eventName) return alert("Please select an event");

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (msg) => {
        const timestamp = new Date().toISOString();
        if (!scans[eventName]) scans[eventName] = [];

        const isDuplicate = scans[eventName].some(entry => entry.data === msg);
        if (!isDuplicate) {
          scans[eventName].push({ data: msg, time: timestamp });
          updateLog(eventName);
          saveData();
        } else {
          log.innerText = `‚ö†Ô∏è Already checked in:\n${msg}\n\n` + log.innerText;
        }
      },
      (err) => {}
    );
  }

  function updateLog(eventName) {
    log.innerText = scans[eventName].map(s => `üü¢ ${s.data} \n‚è± ${s.time}`).join("\n\n");
  }

  function exportCSV() {
    let csv = "Event,Data,Timestamp\n";
    for (const [event, entries] of Object.entries(scans)) {
      for (const entry of entries) {
        csv += `"${event}","${entry.data.replace(/"/g, '""')}","${entry.time}"\n`;
      }
    }

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "checkin_data.csv";
    a.click();
    URL.revokeObjectURL(url);
  }
</script>
